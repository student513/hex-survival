--
local CollectionService = game:GetService('CollectionService')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local ServerStorage = game:GetService('ServerStorage')

-- ìŠ¤í¬ë¦°ìƒ·ì—ì„œ í™•ì¸ëœ ëŒ€ë¬¸ì Shared ê²½ë¡œ ë°˜ì˜
local Shared = ReplicatedStorage:WaitForChild("Shared")
local HexConstants = require(Shared:WaitForChild("HexConstants"))

local MapService = {}

--
function MapService.createLobby()
	local lobbyCenter = Vector3.new(0, 500, 0)
	local lobbySize = 70 -- ê°€ë¡œì„¸ë¡œ 150ì˜ ë„‰ë„‰í•œ í¬ê¸°
	local wallHeight = 40

	-- 1. ì‚¬ê°í˜• ë°”ë‹¥ ìƒì„±
	local floor = Instance.new("Part")
	floor.Name = "LobbyFloor"
	floor.Size = Vector3.new(lobbySize, 1, lobbySize)
	floor.Position = lobbyCenter
	floor.Anchored = true
	floor.Transparency = 0.5
	floor.Material = Enum.Material.SmoothPlastic
	floor.Parent = workspace
	-- ë°Ÿì•„ë„ ì•ˆ ì‚¬ë¼ì§€ê²Œ LobbyTagë§Œ ì¶”ê°€
	game:GetService("CollectionService"):AddTag(floor, "LobbyTag")

	-- 2. ì‚¬ê°í˜• ë²½ ìƒì„± (4ë©´)
	local wallData = {
		{pos = Vector3.new(0, wallHeight/2, lobbySize/2), size = Vector3.new(lobbySize, wallHeight, 1)}, -- ì•
		{pos = Vector3.new(0, wallHeight/2, -lobbySize/2), size = Vector3.new(lobbySize, wallHeight, 1)}, -- ë’¤
		{pos = Vector3.new(lobbySize/2, wallHeight/2, 0), size = Vector3.new(1, wallHeight, lobbySize)}, -- ìš°
		{pos = Vector3.new(-lobbySize/2, wallHeight/2, 0), size = Vector3.new(1, wallHeight, lobbySize)} -- ì¢Œ
	}

	for _, data in ipairs(wallData) do
		local wall = Instance.new("Part")
		wall.Size = data.size
		wall.Position = lobbyCenter + data.pos
		wall.Anchored = true
		wall.Transparency = 0
		wall.Material = Enum.Material.Glass
		wall.Parent = workspace
		game:GetService("CollectionService"):AddTag(wall, "LobbyTag")
	end

	-- 3. ìŠ¤í° ì§€ì  ìƒì„±
	local spawnLoc = Instance.new("SpawnLocation")
	spawnLoc.Position = lobbyCenter + Vector3.new(0, 2, 0)
	spawnLoc.Size = Vector3.new(10, 1, 10)
	spawnLoc.Anchored = true
	spawnLoc.Transparency = 1
	spawnLoc.Parent = workspace
	game:GetService("CollectionService"):AddTag(spawnLoc, "LobbyTag")

	print("âœ… ì‚¬ê°í˜• ëŒ€ê¸°ì‹¤ ìƒì„± ì™„ë£Œ (í‹ˆìƒˆ ì—†ìŒ)")
end

-- 2. ê²Œì„ìš© 8ì¸µ ë§µ ìƒì„± í•¨ìˆ˜
function MapService.generateMap()
	local hexTemplate = ServerStorage:WaitForChild("HexPart", 5)
	if not hexTemplate then return end

	local mapFolder = workspace:FindFirstChild("Map") or Instance.new("Folder", workspace)
	mapFolder.Name = "Map"

	-- HexConstants ìˆ˜ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •ë°€ ë°°ì¹˜
	local HEX_WIDTH = 8.66
	local HEX_TALL = 10
	local GAP = 0.2

	local xOffset = HEX_WIDTH + GAP
	local zOffset = (HEX_TALL * 0.75) + (GAP * 0.866)

for floor = 1, HexConstants.FLOORS_COUNT do
		local floorFolder = Instance.new("Folder", mapFolder)
		floorFolder.Name = "Floor_" .. floor

		local yPos = HexConstants.START_HEIGHT + (floor * HexConstants.FLOOR_DISTANCE)
		local delayTime = HexConstants.GET_DELAY_TIME(floor)

		-- [ìˆ˜ì •] ë³´ìˆ˜ì ì¸ ë¹ˆì¹¸ í™•ë¥  ê³„ì‚° (ìµœëŒ€ 15%)
		-- 8ì¸µ: 0% / 1ì¸µ: 15% ê°€ ë˜ë„ë¡ ê³„ì‚°
		local maxGapPercent = 15
		local gapProbability = 0

		if floor < HexConstants.FLOORS_COUNT then
			-- ì¸µì´ ë‚´ë ¤ê°ˆìˆ˜ë¡(floor ìˆ«ìê°€ ì‘ì•„ì§ˆìˆ˜ë¡) í™•ë¥  ì¦ê°€
			gapProbability = (HexConstants.FLOORS_COUNT - floor) * (maxGapPercent / (HexConstants.FLOORS_COUNT - 1))
		end

		for q = -HexConstants.GRID_SIZE, HexConstants.GRID_SIZE do
			for r = math.max(-HexConstants.GRID_SIZE, -q - HexConstants.GRID_SIZE), math.min(HexConstants.GRID_SIZE, -q + HexConstants.GRID_SIZE) do

				-- [í•µì‹¬] ì„¤ì •ëœ í™•ë¥ ë¡œ ë°œíŒ ìƒì„±ì„ ê±´ë„ˆëœ€
				if gapProbability > 0 then
					if math.random(1, 100) <= gapProbability then
						continue -- ë¹ˆì¹¸ ìƒì„±
					end
				end

				local newPart = hexTemplate:Clone()
				game:GetService("CollectionService"):AddTag(newPart, "HexPlatform")

				local x = xOffset * (q + r/2)
				local z = zOffset * r

				newPart.Position = Vector3.new(x, yPos, z)
				newPart.Parent = floorFolder
				newPart:SetAttribute("DelayTime", delayTime)
			end
		end
		print(string.format("Floor %d: Gap Chance %.1f%%", floor, gapProbability))
	end
end

function MapService.createKillZone()
	local size = 2048 -- ë§µ ì „ì²´ë¥¼ ë®ëŠ” ì¶©ë¶„í•œ í¬ê¸°
	local height = 20 -- 1ì¸µ(130)ë³´ë‹¤ í›¨ì”¬ ì•„ë˜ì¸ ì§€ì 

	local killPart = Instance.new("Part")
	killPart.Name = "KillZone"
	killPart.Size = Vector3.new(size, 2, size)
	killPart.Position = Vector3.new(0, height, 0)
	killPart.Anchored = true
	killPart.CanCollide = false -- í†µê³¼í•  ìˆ˜ ìˆì–´ì•¼ í•¨
	killPart.Transparency = 1 -- í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë°˜íˆ¬ëª…í•˜ê²Œ (ë‚˜ì¤‘ì— 1ë¡œ ë³€ê²½ ê°€ëŠ¥)
	killPart.Material = Enum.Material.Neon
	killPart.Parent = workspace

	-- ë‹¿ìœ¼ë©´ ì£½ëŠ” ì´ë²¤íŠ¸ ì—°ê²°
	killPart.Touched:Connect(function(hit)
		local character = hit.Parent
		local humanoid = character:FindFirstChild("Humanoid")
		if humanoid then
			humanoid.Health = 0 -- ì¦‰ì‚¬
		end
	end)

	print("ğŸ”¥ Kill Zone (Lava) created at height: " .. height)
end

return MapService